#!/usr/bin/env python
"""
Prune the archive of corrupted exposures.
"""
import os,sys
import logging
import subprocess
import glob

import numpy as np
import fitsio

from archive.parser import VerboseAction, Parser

def parser():
    parser = Parser(description=__doc__)
    parser.add_argument('--outdir',default='/data/des51.b/data/DTS/src',
                        help='directory of local archive')
    parser.add_argument('-m','--min-size',default=250,type=float,
                        help='minimum file size (MB)')
    return parser
   

if __name__ == "__main__":
    args = parser().parse_args()

    files = sorted(glob.glob(args.outdir+'/[0-9]*[0-9]/DECam_[0-9]*.fits.fz'))
    nfiles = len(files)

    logging.info("Pruning %s files..."%nfiles)
    for i,f in enumerate(files):
        if i%1000==0: 
            msg = '(%-07i/%-07i): %s'%(i,nfiles,f)
            logging.info(msg)

        # Ignore (trust) links for now
        if os.path.islink(f): continue

        # Check for small files
        if os.path.getsize(f)/1024**2 < args.min_size:
            # Check number of HDUs
            try: 
                if len(fitsio.FITS(f)) == 71: continue
            except IOError: 
                pass

            # Remove the corrupted file
            logging.info('Removing %s...'%f)
            if not args.dryrun: os.remove(f)
